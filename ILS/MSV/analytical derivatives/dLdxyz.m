% Ultralytics ðŸš€ AGPL-3.0 License - https://ultralytics.com/license

clc; clear all
syms r p y x y z BAx BAy BAz vx vy vz real
syms Ax Ay Az Bx By Bz Tx Ty Tz real

TAx = Tx-Ax; %T = Tie Point; A = Aircraft
TAy = Ty-Ay;
TAz = Tz-Az;

%CC2ELAZ
p = asin(-TAz./sqrt(TAx .^2 + TAy.^2 + TAz.^2)); %pointing angle to tp1
y = atan(TAy/TAx);  %pointing angle to tp1

%ROTATE
cr=cos(r); sr=sin(r);
cp=cos(p); sp=sin(p);
cy=cos(y); sy=sin(y);
ux=x.*(cp.*cy) +y.*(sr.*sp.*cy-cr.*sy)  +z.*(cr.*sp.*cy+sr.*sy);  %[ux1,uy1,uz1] = fcnrotateW2Brpyxyz(sr,sp,sy,cr,cp,cy,x,y,z);
uy=x.*(cp.*sy) +y.*(sr.*sp.*sy+cr.*cy)  +z.*(cr.*sp.*sy-sr.*cy);
uz=x.*(-sp)    +y.*(sr.*cp)             +z.*(cr.*cp);

%VECTOR INTERCEPTS
d = ux.*vx + uy.*vy + uz.*vz;
e = ux.*BAx + uy.*BAy + uz.*BAz;
f = vx.*BAx + vy.*BAy + vz.*BAz;
g = 1 - d.*d;
s1 = (d.*f - e)./g; %multiply times u
t1 = (f - d.*e)./g; %multiply times v

%MISCLOSURE VECTOR RANGE RESIDUALS
L = sqrt( (t1.*vx-BAx-s1.*ux).^2 + (t1.*vy-BAy-s1.*uy).^2 + (t1.*vz-BAz-s1.*uz).^2 );
dLdTx = diff(L,Tx);  %t2=Ax-Tx; t3=Ay-Ty; t4=Az-Tz; t5=t4^2; t6=t2^2; t7=t3^2; t8=t5+t6+t7; t9=1/t8; t22=t5*t9; t10=1-t22; t11=t10^(1/2); t12=1/t2; t13=t3*t12; t14=atan(t13); t15=cos(r); t16=sin(r); t17=1/t2^2; t18=t7*t17; t19=t18+1; t20=1/t19^(1/2); t21=1/t8^(1/2); t24=t4*t21*x; t25=t11*t15*z; t26=t11*t14*t16; t27=t25-t24+t26; t28=t3*t12*t15*t20; t29=t4*t16*t20*t21; t30=t28-t29; t31=t14*t30; t32=t3*t12*t16*t20; t33=t4*t15*t20*t21; t34=t32+t33; t35=t34*z; t36=t11*t20*x; t37=t35-t31+t36; t38=t15*t20; t39=t3*t4*t12*t16*t20*t21; t40=t38+t39; t41=t14*t40; t42=t16*t20; t43=t3*t4*t12*t15*t20*t21; t44=t42-t43; t45=t44*z; t46=t3*t11*t12*t20*x; t47=t41-t45+t46; t48=t27*vz; t49=t37*vx; t50=t47*vy; t23=t48+t49+t50; t51=t23^2; t52=t51-1; t53=1/t52; t54=BAz*t27; t55=BAx*t37; t56=BAy*t47; t57=BAx*vx; t58=BAy*vy; t59=BAz*vz; t61=t54+t55+t56; t62=t23*t61; t63=t57+t58+t59-t62; t64=t57+t58+t59; t65=t23*t64; t66=t54+t55+t56-t65; t125=t53*t63*vz; t126=t27*t53*t66; t60=BAz+t125+t126; t130=t53*t63*vx; t131=t37*t53*t66; t67=BAx+t130+t131; t69=t53*t63*vy; t70=t47*t53*t66; t68=BAy+t69+t70; t71=2*Ax; t72=2*Tx; t73=t71-t72; t74=1/t10^(1/2); t75=1/t8^2; t76=1/t19^(3/2); t77=1/t8^(3/2); t78=1/t2^3; t79=1/t2^4; t80=1/t19; t81=t7*t16*t76*t78; t82=t3*t4*t15*t17*t20*t21; t83=(t3*t4*t12*t15*t20*t73*t77)/2; t106=t3*t4*t7*t15*t21*t76*t79; t84=t81+t82+t83-t106; t85=t84*z; t86=t7*t15*t76*t78; t87=t3*t4*t7*t16*t21*t76*t79; t107=t3*t4*t16*t17*t20*t21; t108=(t3*t4*t12*t16*t20*t73*t77)/2; t88=t86+t87-t107-t108; t89=t3*t17*t40*t80; t90=t3*t11*t17*t20*x; t109=t14*t88; t110=t3*t7*t11*t76*t79*x; t111=(t3*t5*t12*t20*t73*t74*t75*x)/2; t91=t85+t89+t90-t109-t110-t111; t92=t3*t16*t17*t20; t93=(t4*t15*t20*t73*t77)/2; t112=t3*t7*t16*t76*t79; t113=t4*t7*t15*t21*t76*t78; t94=t92+t93-t112-t113; t95=t3*t15*t17*t20; t96=t4*t7*t16*t21*t76*t78; t115=t3*t7*t15*t76*t79; t116=(t4*t16*t20*t73*t77)/2; t97=t14*(t95+t96-t115-t116); t98=t3*t17*t30*t80; t99=t7*t11*t76*t78*x; t100=(t5*t20*t73*t74*t75*x)/2; t114=t94*z; t101=t97+t98+t99+t100-t114; t102=(t4*t73*t77*x)/2; t103=(t5*t14*t16*t73*t74*t75)/2; t104=(t5*t15*t73*t74*t75*z)/2; t118=t3*t11*t16*t17*t80; t105=t102+t103+t104-t118; t117=BAx*t101; t119=t105*vz; t120=t101*vx; t123=t91*vy; t121=t119+t120-t123; t122=BAz*t105; t124=1/t52^2; t129=BAy*t91; t135=t64*t121; t127=t117+t122-t129-t135; t128=t61*t121; t132=t117+t122-t129; t133=t23*t132; t134=t128+t133; t1=(2*t68*(t53*vy*(t128+t23*(t117+t122-BAy*t91))+t53*t66*t91-t47*t53*t127+2*t23*t47*t66*t121*t124+2*t23*t63*t121*t124*vy)+2*t67*(t53*t134*vx-t53*t66*t101-t37*t53*t127+2*t23*t37*t66*t121*t124+2*t23*t63*t121*t124*vx)+2*t60*(t53*t134*vz-t53*t66*t105-t27*t53*t127+2*t23*t27*t66*t121*t124+2*t23*t63*t121*t124*vz))/(2*(t60^2+t67^2+t68^2)^(1/2));
dLdTy = diff(L,Ty);  %t2=Ax-Tx; t3=Ay-Ty; t4=Az-Tz; t5=t4^2; t6=t2^2; t7=t3^2; t8=t5+t6+t7; t9=1/t8; t22=t5*t9; t10=1-t22; t11=t10^(1/2); t12=1/t2; t13=t3*t12; t14=atan(t13); t15=cos(r); t16=sin(r); t17=1/t2^2; t18=t7*t17; t19=t18+1; t20=1/t19^(1/2); t21=1/t8^(1/2); t24=t4*t21*x; t25=t11*t15*z; t26=t11*t14*t16; t27=t25-t24+t26; t28=t3*t12*t15*t20; t29=t4*t16*t20*t21; t30=t28-t29; t31=t14*t30; t32=t3*t12*t16*t20; t33=t4*t15*t20*t21; t34=t32+t33; t35=t34*z; t36=t11*t20*x; t37=t35-t31+t36; t38=t15*t20; t39=t3*t4*t12*t16*t20*t21; t40=t38+t39; t41=t14*t40; t42=t16*t20; t43=t3*t4*t12*t15*t20*t21; t44=t42-t43; t45=t44*z; t46=t3*t11*t12*t20*x; t47=t41-t45+t46; t48=t27*vz; t49=t37*vx; t50=t47*vy; t23=t48+t49+t50; t51=t23^2; t52=t51-1; t53=1/t52; t54=BAz*t27; t55=BAx*t37; t56=BAy*t47; t57=BAx*vx; t58=BAy*vy; t59=BAz*vz; t60=t54+t55+t56; t61=2*Ay; t62=2*Ty; t63=t61-t62; t64=1/t19^(3/2); t65=1/t8^(3/2); t66=1/t2^3; t67=1/t19; t68=1/t10^(1/2); t69=1/t8^2; t70=(t3*t16*t63*t64*t66)/2; t71=(t4*t15*t20*t63*t65)/2; t72=(t4*t15*t17*t21*t63*t64)/2; t107=t12*t16*t20; t73=t70+t71+t72-t107; t74=t73*z; t75=t12*t15*t20; t76=(t4*t16*t20*t63*t65)/2; t77=(t4*t16*t17*t21*t63*t64)/2; t108=(t3*t15*t63*t64*t66)/2; t78=t75+t76+t77-t108; t79=t14*t78; t80=t12*t30*t67; t81=(t11*t17*t63*t64*x)/2; t109=(t5*t20*t63*t68*t69*x)/2; t82=t74+t79+t80+t81-t109; t83=t11*t12*t16*t67; t84=(t4*t63*t65*x)/2; t85=(t5*t14*t16*t63*t68*t69)/2; t86=(t5*t15*t63*t68*t69*z)/2; t87=t83+t84+t85+t86; t88=(t16*t17*t63*t64)/2; t89=t4*t12*t15*t20*t21; t102=(t3*t4*t12*t15*t20*t63*t65)/2; t103=(t3*t4*t15*t21*t63*t64*t66)/2; t90=t88+t89-t102-t103; t91=t90*z; t92=(t15*t17*t63*t64)/2; t93=(t3*t4*t12*t16*t20*t63*t65)/2; t94=(t3*t4*t16*t21*t63*t64*t66)/2; t104=t4*t12*t16*t20*t21; t95=t92+t93+t94-t104; t96=t12*t40*t67; t97=t11*t12*t20*x; t98=(t3*t5*t12*t20*t63*t68*t69*x)/2; t105=t14*t95; t106=(t3*t11*t63*t64*t66*x)/2; t99=t91+t96+t97+t98-t105-t106; t100=t57+t58+t59; t118=t23*t100; t101=t54+t55+t56-t118; t110=BAz*t87; t111=t99*vy; t112=t87*vz; t115=t82*vx; t113=t111+t112-t115; t114=BAy*t99; t119=t23*t60; t116=t57+t58+t59-t119; t117=1/t52^2; t122=BAx*t82; t126=t100*t113; t120=t110+t114-t122-t126; t121=t60*t113; t123=t110+t114-t122; t124=t23*t123; t125=t121+t124; t127=t53*t116*vz; t128=t27*t53*t101; t129=BAz+t127+t128; t130=t53*t116*vx; t131=t37*t53*t101; t132=BAx+t130+t131; t133=t53*t116*vy; t134=t47*t53*t101; t135=BAy+t133+t134; t1=(2*t135*(t53*vy*(t121+t23*(t110+t114-BAx*t82))-t47*t53*t120-t53*t99*t101+2*t23*t47*t101*t113*t117+2*t23*t113*t116*t117*vy)+2*t132*(t53*t82*t101-t37*t53*t120+t53*t125*vx+2*t23*t37*t101*t113*t117+2*t23*t113*t116*t117*vx)+2*t129*(t53*t125*vz-t53*t87*t101-t27*t53*t120+2*t23*t27*t101*t113*t117+2*t23*t113*t116*t117*vz))/(2*(t129^2+t132^2+t135^2)^(1/2));
dLdTz = diff(L,Tz);  %t2=Ax-Tx; t3=Ay-Ty; t4=Az-Tz; t5=t4^2; t6=t2^2; t7=t3^2; t8=t5+t6+t7; t9=1/t8; t22=t5*t9; t10=1-t22; t11=t10^(1/2); t12=1/t2; t13=t3*t12; t14=atan(t13); t15=cos(r); t16=sin(r); t17=1/t2^2; t18=t7*t17; t19=t18+1; t20=1/t19^(1/2); t21=1/t8^(1/2); t24=t4*t21*x; t25=t11*t15*z; t26=t11*t14*t16; t27=t25-t24+t26; t28=t3*t12*t15*t20; t29=t4*t16*t20*t21; t30=t28-t29; t31=t14*t30; t32=t3*t12*t16*t20; t33=t4*t15*t20*t21; t34=t32+t33; t35=t34*z; t36=t11*t20*x; t37=t35-t31+t36; t38=t15*t20; t39=t3*t4*t12*t16*t20*t21; t40=t38+t39; t41=t14*t40; t42=t16*t20; t43=t3*t4*t12*t15*t20*t21; t44=t42-t43; t45=t44*z; t46=t3*t11*t12*t20*x; t47=t41-t45+t46; t48=t27*vz; t49=t37*vx; t50=t47*vy; t23=t48+t49+t50; t51=t23^2; t52=t51-1; t53=1/t52; t54=BAz*t27; t55=BAx*t37; t56=BAy*t47; t57=BAx*vx; t58=BAy*vy; t59=BAz*vz; t60=t54+t55+t56; t61=2*Az; t62=2*Tz; t63=t61-t62; t64=1/t8^(3/2); t65=1/t10^(1/2); t66=t9*t63; t67=1/t8^2; t69=t5*t63*t67; t68=t66-t69; t70=t15*t20*t21; t88=(t4*t15*t20*t63*t64)/2; t71=t70-t88; t72=t71*z; t73=t16*t20*t21; t89=(t4*t16*t20*t63*t64)/2; t74=t73-t89; t75=t14*t74; t90=(t20*t65*t68*x)/2; t76=t72+t75-t90; t77=t21*x; t78=(t15*t65*t68*z)/2; t79=(t14*t16*t65*t68)/2; t92=(t4*t63*t64*x)/2; t80=t77+t78+t79-t92; t81=t3*t12*t15*t20*t21; t93=(t3*t4*t12*t15*t20*t63*t64)/2; t82=t81-t93; t83=t82*z; t84=t3*t12*t16*t20*t21; t94=(t3*t4*t12*t16*t20*t63*t64)/2; t85=t84-t94; t86=t14*t85; t95=(t3*t12*t20*t65*t68*x)/2; t87=t83+t86-t95; t91=t76*vx; t96=t87*vy; t102=t80*vz; t97=t91+t96-t102; t98=t57+t58+t59; t99=BAx*t76; t100=BAy*t87; t105=t23*t98; t101=t54+t55+t56-t105; t106=t23*t60; t103=t57+t58+t59-t106; t104=1/t52^2; t107=t60*t97; t111=BAz*t80; t108=t99+t100-t111; t109=t23*t108; t110=t107+t109; t112=t99+t100-t111-t97*t98; t113=t53*t103*vz; t114=t27*t53*t101; t115=BAz+t113+t114; t116=t53*t103*vx; t117=t37*t53*t101; t118=BAx+t116+t117; t119=t53*t103*vy; t120=t47*t53*t101; t121=BAy+t119+t120; t1=(2*t121*(t53*t110*vy-t53*t87*t101-t47*t53*t112+2*t23*t47*t97*t101*t104+2*t23*t97*t103*t104*vy)+2*t115*(t53*t80*t101-t27*t53*t112+t53*t110*vz+2*t23*t27*t97*t101*t104+2*t23*t97*t103*t104*vz)+2*t118*(t53*t110*vx-t53*t76*t101-t37*t53*(t99+t100-BAz*t80-t97*t98)+2*t23*t37*t97*t101*t104+2*t23*t97*t103*t104*vx))/(2*(t115^2+t118^2+t121^2)^(1/2));
dLdr1 = diff(L,r);   %t2=Ax-Tx; t3=Ay-Ty; t4=Az-Tz; t5=t4^2; t6=t2^2; t7=t3^2; t8=t5+t6+t7; t9=1/t8; t22=t5*t9; t10=1-t22; t11=t10^(1/2); t12=1/t2; t13=t3*t12; t14=atan(t13); t15=cos(r); t16=sin(r); t17=1/t2^2; t18=t7*t17; t19=t18+1; t20=1/t19^(1/2); t21=1/t8^(1/2); t24=t4*t21*x; t25=t11*t15*z; t26=t11*t14*t16; t27=t25-t24+t26; t28=t3*t12*t15*t20; t29=t4*t16*t20*t21; t30=t28-t29; t31=t14*t30; t32=t3*t12*t16*t20; t33=t4*t15*t20*t21; t34=t32+t33; t35=t34*z; t36=t11*t20*x; t37=t35-t31+t36; t38=t15*t20; t39=t3*t4*t12*t16*t20*t21; t40=t38+t39; t41=t14*t40; t42=t16*t20; t43=t3*t4*t12*t15*t20*t21; t44=t42-t43; t45=t44*z; t46=t3*t11*t12*t20*x; t47=t41-t45+t46; t48=t27*vz; t49=t37*vx; t50=t47*vy; t23=t48+t49+t50; t51=t23^2; t52=t51-1; t53=1/t52; t54=BAz*t27; t55=BAx*t37; t56=BAy*t47; t57=BAx*vx; t58=BAy*vy; t59=BAz*vz; t61=t54+t55+t56; t62=t23*t61; t63=t57+t58+t59-t62; t64=t57+t58+t59; t65=t23*t64; t66=t54+t55+t56-t65; t94=t53*t63*vz; t95=t27*t53*t66; t60=BAz+t94+t95; t69=t53*t63*vx; t70=t37*t53*t66; t67=BAx+t69+t70; t87=t53*t63*vy; t88=t47*t53*t66; t68=BAy+t87+t88; t71=t11*t14*t15; t79=t11*t16*z; t72=t71-t79; t73=t14*t34; t74=t30*z; t75=t73+t74; t76=t14*t44; t77=t40*z; t78=t76+t77; t80=BAz*t72; t81=BAx*t75; t82=t72*vz; t83=t75*vx; t86=t78*vy; t84=t82+t83-t86; t85=1/t52^2; t93=BAy*t78; t89=t80+t81-t93; t90=t23*t89; t91=t61*t84; t92=t90+t91; t97=t64*t84; t96=t80+t81-t93-t97; t1=-(2*t67*(t53*t92*vx-t53*t66*t75-t37*t53*t96+2*t23*t37*t66*t84*t85+2*t23*t63*t84*t85*vx)+2*t68*(t53*t66*t78-t47*t53*t96+t53*t92*vy+2*t23*t47*t66*t84*t85+2*t23*t63*t84*t85*vy)+2*t60*(t53*t92*vz-t53*t66*t72-t27*t53*t96+2*t23*t27*t66*t84*t85+2*t23*t63*t84*t85*vz))/(2*(t60^2+t67^2+t68^2)^(1/2));

%simpledLdTz = simple(dLdTz,'IgnoreAnalyticConstraints',true)
dLdr3 = feval(symengine,'generate::optimize',dLdTz);
for i=1:numel(dLdr3)
   str = char(dLdr3(i));
   str = strrep(str,'==','=');
   str = strrep(str,'(1/2)','.5');
   str = strrep(str,'*','.*');
   str = strrep(str,'/','./');
   str = strrep(str,'^','.^');
   str = str(~isspace(str));
   fprintf('%s; ', str )
end